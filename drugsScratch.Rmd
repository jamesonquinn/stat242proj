---
title: "drugs"
author: "Jameson Quinn"
date: "April 28, 2015"
output: html_document
---

HIHIHIHIH

```{r}
library(data.table)
library(ggplot2)
library(boot)
library(nsprcomp)
library(plyr)
library(pheatmap)
library(reshape2)

load ("gene_to_geneset_matrix.Rdat")
load ("small_CTD1.Rdat")
load ("small_scaled_micro_array_2.Rdat")


standardize = function(v) {(v-mean(v))/sd(v)}
drugs = data.table(t(aaply(small_CTD1[!is.na(small_scaled_micro_array_2[,1]),],2,standardize)))
genesets = data.table(gene_to_geneset_matrix)
rna = data.table(t(aaply(small_scaled_micro_array_2[!is.na(small_scaled_micro_array_2[,1]),],2,standardize)))

rna2 = data.table(rna)
lastPart = Vectorize(function(s){tail(strsplit(s,split="_")[[1]],1)})
rna2[,type:=as.factor(lastPart(rownames(small_CTD1[!is.na(small_scaled_micro_array_2[,1]),])))]
ndim = 4

if (F) {
  for (alpha in 2+((0:4)*0.25)) {
    alldat = cbind(rna,alpha*drugs)
    pca = nsprcomp(alldat,ndim,k=rep(200,ndim))
    loads = pca$rotation
    cat(alpha, aaply(loads[1:dim(rna)[2],],2,function(v){sum(v != 0)}),"\n")
  
  }
}

alpha = 3
alldat = cbind(rna,alpha*drugs)
cols = c(names(alldat))
alldat[,cancerType:=as.factor(lastPart(rownames(small_CTD1[!is.na(small_scaled_micro_array_2[,1]),])))]
admeans = data.table(alldat)
admeans[,(cols):=lapply(.SD,mean),.SDcols=cols, by=cancerType]
adwithin = as.matrix(alldat[,-(length(cols) + 1),with=FALSE]) - as.matrix(admeans[,-(length(cols) + 1),with=FALSE])


pca = nsprcomp(adwithin,ndim,k=rep(200,ndim))
loads = pca$rotation
cat(alpha, aaply(loads[1:dim(rna)[2],],2,function(v){sum(v != 0)}),"\n")

allsets = cbind(genesets,matrix(0,dim(genesets)[1],dim(drugs)[2]))
allsets = as.matrix(rbind(allsets,cbind(matrix(0,dim(drugs)[2],dim(genesets)[2]),diag(dim(drugs)[2]))))

numLoads = function(dat) {
  d = ifelse(dat != 0, 1,0)
  
  aaply(seq(dim(allsets)[1]),1,function(i){colSums(d * allsets[i,] / sum(allsets[i,]))})
}


nl = numLoads(loads)
overlaps = nl %*% t(nl)

overlapss = melt(overlaps)
setnames(overlapss,c("i","j","value"))
ggplot(overlapss, aes(i,j,fill=value)) + geom_raster()

minNumLoads = 100
maxNumLoads = 200
getOverlap = function(dat,...) {
  
  pca = nsprcomp(adwithin,ndim,k=rep(sample(minNumLoads:maxNumLoads,1),ndim))
  loads = pca$rotation
  nl = numLoads(loads)
  overlaps = nl %*% t(nl)
  print(rbinom(1,1,.5))
  return(overlaps)
}

r = 100
aboot = boot(adwithin, getOverlap, R=r)
overlapMeans = matrix(colMeans(aboot$t),dim(allsets)[1],dim(allsets)[1])

d_inds = seq(dim(genesets)[1]+1,dim(allsets)[1])
g_inds = seq(1,dim(genesets)[1])
rescalerMeans = rbind(cbind(matrix(min(overlapMeans[g_inds,g_inds]),
                              dim(genesets)[1],
                              dim(genesets)[1]), 
                       matrix(min(overlapMeans[g_inds,d_inds]),
                              dim(genesets)[1],
                              dim(drugs)[2])),
                 cbind(matrix(min(overlapMeans[d_inds,g_inds]),
                              dim(drugs)[2],
                              dim(genesets)[1]), 
                       matrix(min(overlapMeans[d_inds,d_inds]),
                              dim(drugs)[2],
                              dim(drugs)[2])))
rrange = function(v) {max(v)-min(v)}
rescalerVar = rbind(cbind(matrix(rrange(overlapMeans[g_inds,g_inds]),
                              dim(genesets)[1],
                              dim(genesets)[1]), 
                       matrix(rrange(overlapMeans[g_inds,d_inds]),
                              dim(genesets)[1],
                              dim(drugs)[2])),
                 cbind(matrix(rrange(overlapMeans[d_inds,g_inds]),
                              dim(drugs)[2],
                              dim(genesets)[1]), 
                       matrix(rrange(overlapMeans[d_inds,d_inds]),
                              dim(drugs)[2],
                              dim(drugs)[2])))

rescaled = (overlapMeans - rescalerMeans)/rescalerVar


dpermute = d_inds[order(rowMeans(rescaled[d_inds,]))]
gpermute = g_inds[order(rowMeans(rescaled[g_inds,]))]
fullpermute = c(gpermute, dpermute)
sortedOverlaps = rescaled[fullpermute,fullpermute]

ddist = dist(rescaled[d_inds,], method="euclidean")
dclust = hclust(ddist, method = "average")
gdist = dist(rescaled[g_inds,], method="euclidean")
gclust = hclust(gdist, method = "average")
allclust = c(gclust$order,dclust$order)

pheatmap(rescaled[allclust,allclust])

overlapss = melt(sortedOverlaps)
setnames(overlapss,c("i","j","value"))
ggplot(overlapss, aes(i,j,fill=value)) + geom_raster()

saveRDS(overlapMeans, "overlapMeans.rds")







dat = Expr$dat
dat2 = aaply(dat,2,function(v){v[is.na(v)]=mean(v,na.rm=T);return(v)})
ppp = spca(dm,10,1:10)
dm = dat2[1:100,1:1000]

start = Sys.time()
pp = nsprcomp(dm, 10, k=rep(25,10))
print(Sys.time()-start)

nmeans = 5
ncol = 1000
nsigcols = 100
sigoff = 45
sigsize = .4
sigdropoff = 1.3
sigsd = .4
noisesd = 1
means = matrix(0,nmeans,ncol)
for (i in 1:nmeans){
  means[i,(i*sigoff):(i*sigoff+nsigcols-1)]=rnorm(nsigcols,0,sigsize)
}

`%+=%` = function(e1,e2) eval.parent(substitute(e1 <- e1 + e2))
nsimdat=100
simdat = matrix(NA,nsimdat,ncol)
for (i in 1:nsimdat) {
  dat = rnorm(ncol,0,noisesd)
  whichmean = sample(1:nmeans,1,prob=(sigdropoff ^ (-(1:nmeans))))
  dat[(whichmean*sigoff):(whichmean*sigoff+nsigcols-1)] %+=% rnorm(nsigcols,0,sigsd)
  dat %+=% means[whichmean,]
  simdat[i,]=dat
}

pp = nsprcomp(simdat, 10, k=rep(25,10))

for (i in 1:nmeans){
    cat(aaply(pp$rotation, 2, function(x) {sum(x[(i*sigoff):(i*sigoff+nsigcols-1)] != 0)}),"\n")
}
```
